# ZOL Solana Integration - Developer Guide

## Table of Contents

1. [Environment Setup](#environment-setup)
2. [IDL Integration Process](#idl-integration-process)
3. [Custom Hooks Usage](#custom-hooks-usage)
4. [Transaction Builders](#transaction-builders)
5. [Architecture Overview](#architecture-overview)
6. [Testing](#testing)
7. [Troubleshooting](#troubleshooting)

---

## Environment Setup

### Prerequisites

- Node.js 18+ and pnpm
- Solana CLI tools (optional, for local testing)
- A Solana wallet (Phantom, Solflare, etc.)

### Installation

1. **Install dependencies:**

```bash
cd Frontend
pnpm install
```

2. **Configure environment variables:**

Create a `.env.local` file in the `Frontend` directory:

```env
# Solana RPC Configuration
NEXT_PUBLIC_SOLANA_RPC_URL=https://api.devnet.solana.com
NEXT_PUBLIC_CLUSTER=devnet

# Program Configuration
NEXT_PUBLIC_ZOL_PROGRAM_ID=Hxmj5SzEPU4gJkbQHWaaXHEQN7SK1CKEuUFhvUf8qBAv

# USDC Configuration (Devnet)
NEXT_PUBLIC_USDC_MINT=4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU
```

3. **Run the development server:**

```bash
pnpm dev
```

### Configuration File

The application uses a centralized configuration file at `lib/config.ts`:

```typescript
import { PublicKey } from '@solana/web3.js';

export const config = {
  rpcUrl: process.env.NEXT_PUBLIC_SOLANA_RPC_URL || 'https://api.devnet.solana.com',
  cluster: process.env.NEXT_PUBLIC_CLUSTER || 'devnet',
  programId: new PublicKey(
    process.env.NEXT_PUBLIC_ZOL_PROGRAM_ID || 
    'Hxmj5SzEPU4gJkbQHWaaXHEQN7SK1CKEuUFhvUf8qBAv'
  ),
  usdcMint: new PublicKey(
    process.env.NEXT_PUBLIC_USDC_MINT || 
    '4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU'
  ),
};
```

---

## IDL Integration Process

### What is an IDL?

The Interface Definition Language (IDL) file is a JSON file generated by Anchor that describes the smart contract's interface. It contains:
- Program instructions and their parameters
- Account structures and types
- Custom types and enums
- Error codes

### Generating the IDL

The IDL is generated when you build the Anchor program:

```bash
cd zol-contract
anchor build
```

This creates `target/idl/zol_contract.json`.

### Integrating the IDL into Frontend

1. **Copy the IDL file:**

```bash
cp zol-contract/target/idl/zol_contract.json Frontend/lib/idl/zol_contract.json
```

2. **Generate TypeScript types:**

The IDL types are defined in `lib/idl/types.ts`:

```typescript
import { Program } from '@coral-xyz/anchor';
import idl from './zol_contract.json';

export type ZolContract = typeof idl;
export type ZolProgram = Program<ZolContract>;
```

3. **Verify the IDL:**

Use the verification utility to ensure all required instructions are present:

```typescript
import { verifyIdl } from '@/lib/idl/verify-idl';

// Verify IDL has required instructions
const isValid = verifyIdl(idl);
```

### IDL Structure

The IDL contains the following key sections:

**Instructions:**
- `initializeGame` - Initialize the game state
- `registerUser` - Register a user with a faction
- `deposit` - Deposit USDC into a faction
- `withdraw` - Withdraw USDC from a faction
- `updateAutomation` - Update x402 automation settings
- `resolveEpoch` - Resolve the current epoch
- `executeSettlement` - Execute settlement and distribute yields
- `startNewEpoch` - Start a new epoch
- `injectYield` - Inject yield into the system

**Accounts:**
- `GameState` - Global game state
- `UserPosition` - Individual user position
- `Vault` - USDC vault account

**Types:**
- `FactionState` - Faction information
- `AutomationSettings` - User automation preferences
- `UserInventory` - User's item inventory

---

## Custom Hooks Usage

### useZolProgram

The core hook for accessing the Anchor program instance.

**Usage:**

```typescript
import { useZolProgram } from '@/hooks/use-zol-program';

function MyComponent() {
  const { program, programId, connection, isReady } = useZolProgram();
  
  if (!isReady) {
    return <div>Loading program...</div>;
  }
  
  // Use program to interact with smart contract
  return <div>Program ready!</div>;
}
```

**Return Values:**
- `program` - Anchor Program instance (null if not ready)
- `programId` - The program's public key
- `connection` - Solana connection instance
- `isReady` - Boolean indicating if program is initialized

### useGameState

Fetches and monitors the global game state.

**Usage:**

```typescript
import { useGameState } from '@/hooks/use-game-state';

function ArenaPage() {
  const { gameState, loading, error, refetch } = useGameState();
  
  if (loading) return <div>Loading game state...</div>;
  if (error) return <div>Error: {error.message}</div>;
  if (!gameState) return <div>No game state found</div>;
  
  return (
    <div>
      <h1>Epoch {gameState.epochNumber.toString()}</h1>
      <p>Total TVL: {gameState.totalTvl.toString()}</p>
      <button onClick={refetch}>Refresh</button>
    </div>
  );
}
```

**Return Values:**
- `gameState` - GameState account data (null if not loaded)
- `loading` - Boolean indicating loading state
- `error` - Error object if fetch failed
- `refetch` - Function to manually refresh data

**Features:**
- Automatic polling every 10 seconds
- Caching with SWR pattern
- Error handling and retry logic

### useUserPosition

Fetches the current user's position data.

**Usage:**

```typescript
import { useUserPosition } from '@/hooks/use-user-position';

function PortfolioPage() {
  const { userPosition, isRegistered, loading, error, refetch } = useUserPosition();
  
  if (loading) return <div>Loading position...</div>;
  if (error) return <div>Error: {error.message}</div>;
  
  if (!isRegistered) {
    return <div>Please register first</div>;
  }
  
  return (
    <div>
      <h2>Your Position</h2>
      <p>Faction: {userPosition.factionId}</p>
      <p>Deposited: {userPosition.depositedAmount.toString()}</p>
    </div>
  );
}
```

**Return Values:**
- `userPosition` - UserPosition account data (null if not registered)
- `isRegistered` - Boolean indicating if user has registered
- `loading` - Boolean indicating loading state
- `error` - Error object if fetch failed
- `refetch` - Function to manually refresh data

### useZolTransactions

Provides functions to execute smart contract transactions.

**Usage:**

```typescript
import { useZolTransactions } from '@/hooks/use-zol-transactions';

function DepositForm() {
  const { deposit, isProcessing, error } = useZolTransactions();
  const [amount, setAmount] = useState('');
  
  const handleDeposit = async () => {
    try {
      const signature = await deposit(parseFloat(amount));
      console.log('Transaction signature:', signature);
    } catch (err) {
      console.error('Deposit failed:', err);
    }
  };
  
  return (
    <div>
      <input 
        type="number" 
        value={amount} 
        onChange={(e) => setAmount(e.target.value)}
        disabled={isProcessing}
      />
      <button onClick={handleDeposit} disabled={isProcessing}>
        {isProcessing ? 'Processing...' : 'Deposit'}
      </button>
      {error && <div>Error: {error.message}</div>}
    </div>
  );
}
```

**Available Functions:**
- `registerUser(factionId: number)` - Register with a faction
- `deposit(amount: number)` - Deposit USDC
- `withdraw(amount: number)` - Withdraw USDC
- `updateAutomation(settings)` - Update automation preferences

**Return Values:**
- Transaction functions (return transaction signature on success)
- `isProcessing` - Boolean indicating if a transaction is in progress
- `error` - Error object if transaction failed

### useTransactionFeedback

Manages transaction UI feedback (loading, success, error states).

**Usage:**

```typescript
import { useTransactionFeedback } from '@/hooks/use-transaction-feedback';

function TransactionComponent() {
  const { 
    showLoading, 
    showSuccess, 
    showError, 
    clearFeedback 
  } = useTransactionFeedback();
  
  const handleTransaction = async () => {
    showLoading('Processing transaction...');
    
    try {
      const signature = await someTransaction();
      showSuccess(signature, 'Transaction successful!');
    } catch (error) {
      showError(error as Error);
    }
  };
  
  return <button onClick={handleTransaction}>Execute</button>;
}
```

### useErrorHandler

Provides error parsing and display utilities.

**Usage:**

```typescript
import { useErrorHandler } from '@/hooks/use-error-handler';

function MyComponent() {
  const { handleError, clearError, error } = useErrorHandler();
  
  const doSomething = async () => {
    try {
      await riskyOperation();
    } catch (err) {
      handleError(err as Error);
    }
  };
  
  return (
    <div>
      {error && (
        <div>
          <p>{error.message}</p>
          <button onClick={clearError}>Dismiss</button>
        </div>
      )}
    </div>
  );
}
```

---

## Transaction Builders

Transaction builders are utility functions that construct Solana transactions for smart contract interactions.

### Location

All transaction builders are in `lib/transaction-builders.ts`.

### buildRegisterUserTx

Creates a transaction to register a user with a faction.

**Signature:**

```typescript
async function buildRegisterUserTx(
  program: ZolProgram,
  userPublicKey: PublicKey,
  factionId: number
): Promise<Transaction>
```

**Parameters:**
- `program` - Anchor program instance
- `userPublicKey` - User's wallet public key
- `factionId` - Faction ID (0-2)

**Example:**

```typescript
import { buildRegisterUserTx } from '@/lib/transaction-builders';
import { useZolProgram } from '@/hooks/use-zol-program';
import { useWallet } from '@solana/wallet-adapter-react';

function RegisterButton() {
  const { program } = useZolProgram();
  const { publicKey, signTransaction } = useWallet();
  
  const register = async (factionId: number) => {
    if (!program || !publicKey || !signTransaction) return;
    
    const tx = await buildRegisterUserTx(program, publicKey, factionId);
    const signed = await signTransaction(tx);
    const signature = await program.provider.connection.sendRawTransaction(
      signed.serialize()
    );
    
    console.log('Registered with signature:', signature);
  };
  
  return <button onClick={() => register(0)}>Register</button>;
}
```

### buildDepositTx

Creates a transaction to deposit USDC into a faction.

**Signature:**

```typescript
async function buildDepositTx(
  program: ZolProgram,
  userPublicKey: PublicKey,
  amount: BN,
  userUsdcAccount: PublicKey
): Promise<Transaction>
```

**Parameters:**
- `program` - Anchor program instance
- `userPublicKey` - User's wallet public key
- `amount` - Amount in lamports (USDC has 6 decimals)
- `userUsdcAccount` - User's USDC token account address

**Example:**

```typescript
import { buildDepositTx } from '@/lib/transaction-builders';
import { BN } from '@coral-xyz/anchor';

const depositAmount = new BN(10_000_000); // 10 USDC
const tx = await buildDepositTx(
  program,
  publicKey,
  depositAmount,
  userUsdcAccount
);
```

### buildWithdrawTx

Creates a transaction to withdraw USDC from a faction.

**Signature:**

```typescript
async function buildWithdrawTx(
  program: ZolProgram,
  userPublicKey: PublicKey,
  amount: BN,
  userUsdcAccount: PublicKey
): Promise<Transaction>
```

**Parameters:**
- Same as `buildDepositTx`

**Example:**

```typescript
import { buildWithdrawTx } from '@/lib/transaction-builders';

const withdrawAmount = new BN(5_000_000); // 5 USDC
const tx = await buildWithdrawTx(
  program,
  publicKey,
  withdrawAmount,
  userUsdcAccount
);
```

### buildUpdateAutomationTx

Creates a transaction to update x402 automation settings.

**Signature:**

```typescript
async function buildUpdateAutomationTx(
  program: ZolProgram,
  userPublicKey: PublicKey,
  settings: AutomationSettings
): Promise<Transaction>
```

**Parameters:**
- `program` - Anchor program instance
- `userPublicKey` - User's wallet public key
- `settings` - Automation settings object

**Example:**

```typescript
import { buildUpdateAutomationTx } from '@/lib/transaction-builders';

const settings = {
  prioritySlot1: { itemId: 1, threshold: new BN(1_000_000) },
  prioritySlot2: { itemId: 2, threshold: new BN(500_000) },
  fallbackAction: { autoCompound: {} }
};

const tx = await buildUpdateAutomationTx(program, publicKey, settings);
```

### Transaction Execution Pattern

The recommended pattern for executing transactions:

```typescript
async function executeTransaction(tx: Transaction) {
  const { connection } = program.provider;
  const { publicKey, signTransaction } = useWallet();
  
  if (!publicKey || !signTransaction) {
    throw new Error('Wallet not connected');
  }
  
  // 1. Get recent blockhash
  const { blockhash } = await connection.getLatestBlockhash();
  tx.recentBlockhash = blockhash;
  tx.feePayer = publicKey;
  
  // 2. Sign transaction
  const signed = await signTransaction(tx);
  
  // 3. Send transaction
  const signature = await connection.sendRawTransaction(signed.serialize());
  
  // 4. Confirm transaction
  await connection.confirmTransaction(signature, 'confirmed');
  
  return signature;
}
```

---

## Architecture Overview

### Data Flow

```
User Action → React Component → Custom Hook → Transaction Builder → 
Wallet Signature → Solana RPC → Smart Contract → On-chain State Update →
Data Refetch → UI Update
```

### Key Components

1. **Wallet Layer** (`components/wallet-provider.tsx`)
   - Manages wallet connections
   - Provides wallet context to app

2. **Program Layer** (`hooks/use-zol-program.ts`)
   - Initializes Anchor program
   - Provides program instance to hooks

3. **Data Layer** (`hooks/use-game-state.ts`, `hooks/use-user-position.ts`)
   - Fetches on-chain data
   - Implements caching and polling

4. **Transaction Layer** (`lib/transaction-builders.ts`, `hooks/use-zol-transactions.ts`)
   - Builds transactions
   - Executes and confirms transactions

5. **UI Layer** (Pages and Components)
   - Displays data
   - Handles user interactions

### PDA (Program Derived Address) System

PDAs are deterministic addresses derived from seeds. The application uses three main PDAs:

```typescript
// Game State PDA
const [gameStatePDA] = PublicKey.findProgramAddressSync(
  [Buffer.from('game_state')],
  programId
);

// User Position PDA
const [userPositionPDA] = PublicKey.findProgramAddressSync(
  [Buffer.from('user'), userPublicKey.toBuffer()],
  programId
);

// Vault PDA
const [vaultPDA] = PublicKey.findProgramAddressSync(
  [Buffer.from('vault')],
  programId
);
```

See `lib/pda.ts` for PDA helper functions.

---

## Testing

### Running Tests

```bash
# Run all tests
pnpm test

# Run tests in watch mode
pnpm test:watch

# Run tests with coverage
pnpm test:coverage
```

### Test Structure

Tests are organized by functionality:

- `__tests__/config.test.ts` - Configuration tests
- `__tests__/idl-integration.test.ts` - IDL verification tests
- `__tests__/pda.test.ts` - PDA derivation tests
- `__tests__/transaction-builders.test.ts` - Transaction builder tests
- `__tests__/use-*.test.ts` - Hook tests

### Writing Tests

Example test for a custom hook:

```typescript
import { renderHook, waitFor } from '@testing-library/react';
import { useGameState } from '@/hooks/use-game-state';

describe('useGameState', () => {
  it('should fetch game state', async () => {
    const { result } = renderHook(() => useGameState());
    
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.gameState).toBeDefined();
  });
});
```

---

## Troubleshooting

### Common Issues

**1. "Wallet not connected" error**

Ensure the wallet is connected before attempting transactions:

```typescript
const { connected } = useWallet();

if (!connected) {
  return <div>Please connect your wallet</div>;
}
```

**2. "Account not found" error**

This usually means the user hasn't registered yet. Check registration status:

```typescript
const { isRegistered } = useUserPosition();

if (!isRegistered) {
  // Show registration flow
}
```

**3. Transaction simulation failed**

Check that:
- User has sufficient SOL for transaction fees
- User has sufficient USDC for deposits
- All account addresses are correct
- The program is deployed and accessible

**4. RPC rate limiting**

If you're hitting rate limits, consider:
- Using a paid RPC provider
- Implementing request queuing
- Increasing cache TTL values

**5. IDL type mismatches**

If you see TypeScript errors after updating the smart contract:
1. Rebuild the contract: `anchor build`
2. Copy the new IDL: `cp target/idl/zol_contract.json Frontend/lib/idl/`
3. Restart the dev server

### Debug Mode

Enable debug logging:

```typescript
import { logger } from '@/lib/logger';

logger.setLevel('debug');
```

### Useful Commands

```bash
# Check Solana CLI version
solana --version

# Check wallet balance
solana balance <WALLET_ADDRESS> --url devnet

# View account data
solana account <ACCOUNT_ADDRESS> --url devnet

# View transaction details
solana confirm <SIGNATURE> --url devnet
```

### Getting Help

- Check the [Solana documentation](https://docs.solana.com/)
- Check the [Anchor documentation](https://www.anchor-lang.com/)
- Review existing tests for usage examples
- Check the error logs in the browser console

---

## Additional Resources

- [Solana Web3.js Documentation](https://solana-labs.github.io/solana-web3.js/)
- [Anchor Framework](https://www.anchor-lang.com/)
- [Solana Wallet Adapter](https://github.com/solana-labs/wallet-adapter)
- [SPL Token Program](https://spl.solana.com/token)
